---
title: "Household Survey Processing"
author: "Caliper Corporation"
date: "February 8, 2021"
output: 
  html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
options(dplyr.summarise.inform = FALSE)
options(scipen = 999)

library(tidyverse)
library(broom)
library(readxl)
library(ggplot2)
library(plotly)
library(leaflet)
library(sf)
library(geosphere)
library(knitr)
library(scales)
library(kableExtra)

source("R/eda.R")
```

```{r read_data, message=FALSE}
# Household files
hh_2016_raw <- read_excel("data/input/_PRIVATE/survey_data/SurveyData_Caliper/2016 Recurrent HTS/1_Data - Original/2016HTS_Data_Main_Households_Final_2016-06-22_RSG.xlsx")
# I exported an xlsx from the access database these were in
combined_hh_weights_2016 <- read_excel("data/input/_PRIVATE/survey_data/SurveyData_Caliper/2016 Recurrent HTS/1_Data - Original/combined_hh_weights_2016.xlsx")
hh_2016_raw <- hh_2016_raw %>%
  left_join(combined_hh_weights_2016, by = c("hhID" = "hhid"))
hh_2018_raw <- read_excel("data/input/_PRIVATE/survey_data/SurveyData_Caliper/2018 Recurrent HTS/1_Data - Original/2018RHTS_HH_2020-04-28.xlsx")

# Person files
per_2016_raw <- read_excel("data/input/_PRIVATE/survey_data/SurveyData_Caliper/2016 Recurrent HTS/1_Data - Original/2016HTS_Data_Main_Persons_Final_2016-07-01_RSG.xlsx")
per_2018_raw <- read_excel("data/input/_PRIVATE/survey_data/SurveyData_Caliper/2018 Recurrent HTS/1_Data - Original/2018RHTS_Person_2020-04-28.xlsx")

# Trip files
trips_2016_raw <- read_excel("data/input/_PRIVATE/survey_data/SurveyData_Caliper/2016 Recurrent HTS/1_Data - Original/2016HTS_Data_Main_Trips_Final_2016-06-22_RSG.xlsx")
# I exported an xlsx from the access database these were in
combined_trip_weights_2016 <- read_excel("data/input/_PRIVATE/survey_data/SurveyData_Caliper/2016 Recurrent HTS/1_Data - Original/combined_trip_weights_2016.xlsx") %>%
  mutate(
    hhid = as.numeric(hhid)
    # personnum = str_pad(personnum, "2", "left", "0"),
    # tripnum = str_pad(tripnum, "3", "left", "0"),
    # hhID = paste0(hhid, personnum, tripnum)
  )
trips_2016_raw <- trips_2016_raw %>%
  left_join(
    combined_trip_weights_2016, 
    by = c("hhID" = "hhid", "personNum" = "personnum", "tripNum" = "tripnum")
  )
trips_2018_raw <- read_excel("data/input/_PRIVATE/survey_data/SurveyData_Caliper/2018 Recurrent HTS/1_Data - Original/2018RHTS_Trip_2020-04-28.xlsx")
```

## Introduction

The Institute for Transportation Research and Education (ITRE) on behalf of the
Triangle Region stakeholders, began conducting rolling household travel surveys
in 2016. For the TRMG2 estimation, both the 2016 and 2018 surveys are available.
This page documents the combination of those surveys along with any general
processing steps not specific to a particular model.

*TODO: Add more about why we process surveys. Also cover basics of the survey
and the tables it contains.*

## Survey combination

When RSG delivered the 2018 survey, they provided weighting and expansion
factors for 2018 using two data sets:

  * Only the 2018 samples
  * A combination of 2016 and 2018 samples
  
The combined data set expansion was controlled using 2018 American Community
Survey (ACS) marginals. For TRMG2, with a 2016 base year, these weights were
deemed close enough. For example, the table below shows that the original and
combined weights for the 2016 records produce effectively the same distribution
of household size.

```{r}
remove_na_2016 <- hh_2016_raw %>%
  filter(!is.na(hhweight))
remove_na_2018 <- hh_2018_raw %>%
  filter(!is.na(hh_weight_2018))

remove_na_2016 %>%
  mutate(hhsize = ifelse(hhsize > 5, 5, hhsize)) %>%
  group_by(hhsize) %>%
  summarize(
    weight_2016 = sum(hhweight),
    weight_combined = sum(hh_weight_combined)
  ) %>%
  mutate(
    pct_16 = round(weight_2016 / sum(weight_2016), 3),
    pct_16 = percent(pct_16),
    pct_combined = round(weight_combined / sum(weight_combined), 3),
    pct_combined = percent(pct_combined)
  ) %>%
  select(
    `HH Size` = hhsize, `2016 weights` = pct_16,
    `Combined Weights` = pct_combined
  ) %>%
  kable() %>%
  kable_styling(full_width = FALSE)
```

For models where absolute counts of households matter (like trip production),
the weights will be scaled down to match the 2016 socio-economic (SE) data's
total household count. For models focused on percentages (e.g. destination and
mode choice), the raw weights will be used in estimation and calibration. This
includes target creation for mode choice.

### Household table

The 2016 survey household table did have slight differences in the field names
and definitions from the 2018 survey. Compared to the person and trip tables,
the household table was easy to combine and did not result in losing any
information.

```{r combine_hhs}
prep_2016 <- remove_na_2016 %>%
  rename(hhid = hhID) %>%
  mutate(
    year = 2016,
    hh_income_broad = ifelse(
      hh_income_broad %in% c(5, 99), hhincome_imputed, hh_income_broad
    )
  ) %>%
  select(-hhweight, -hhincome_imputed, -secondhome)
prep_2018 <- remove_na_2018 %>%
  mutate(
    year = 2018,
    home_loc_puma = str_pad(home_loc_puma, 5, "left", pad = "0"),
    home_loc_tract = str_pad(home_loc_tract, 6, "left", pad = "0"),
    hh_income_broad = ifelse(
      imputed_income_flag == 1 | hh_income_broad == 99,
      hh_income_imputed, hh_income_broad
    )
  ) %>%
  select(
    -imputed_income_flag, -hh_weight_2018, -hh_income_imputed,
    -personhh_income_flag
  )

hh_combined <- bind_rows(
  prep_2016, prep_2018
)

hh_add_flags <- hh_combined %>%
  mutate(
    child_in_hh = ifelse(num_children > 0, 1, 0),
    worker_in_hh = ifelse(num_workers > 0, 1, 0),
    vehicle_in_hh = ifelse(num_vehicles > 0, 1, 0),
  ) %>%
  relocate(child_in_hh, .before = num_children) %>%
  relocate(worker_in_hh, .before = num_workers) %>%
  relocate(vehicle_in_hh, .before = num_vehicles) %>%
  mutate(
    hh_income_midpt = case_when(
      hh_income_broad == 1 ~ 12500,
      hh_income_broad == 2 ~ 37500,
      hh_income_broad == 3 ~ 62500,
      hh_income_broad == 4 ~ 87500,
      hh_income_broad == 5 ~ 125000,
      TRUE ~ 200000
    )
  ) %>%
  relocate(hh_income_midpt, .after = hh_income_broad)

# Create an income column that marks each household with the income bins
# developed for the disaggregate model.
hh_add_income_final <- hh_add_flags %>%
  mutate(
    hh_inc_final = case_when(
      hh_income_broad == 1 ~ 1,
      hh_income_broad <= 3 ~ 2,
      hh_income_broad == 4 ~ 3,
      TRUE ~ 4
    ),
    hh_inc_final_lab = case_when(
      hh_inc_final == 1 ~ "25k",
      hh_inc_final == 2 ~ "75k",
      hh_inc_final == 3 ~ "150k",
      hh_inc_final == 4 ~ "150k+"
    )
  ) %>%
  relocate(hh_inc_final:hh_inc_final_lab, .after = hh_income_midpt)

hh_add_choice_markets <- hh_add_income_final %>%
  mutate(
    veh_sufficient = ifelse(num_vehicles < num_adults, "vi", "vs"),
    choice_segment = case_when(
      num_vehicles == 0 ~ "v0",
      hh_inc_final <= 2 ~ paste0("il", veh_sufficient),
      TRUE ~ paste0("ih", veh_sufficient)
    )
  )
```

### Person table

The person table changed substantially between 2016 and 2018. As an example,
race included 6 categories in 2016 and was contained in a single column. In
2018, race only had 5 categories and was contained in 5 separate binary columns
(e.g. `race_white` = 1 or 0). These formats had to be rectified, and the "Two+"
race category from 2016 collapsed into "Other", before the tables could be
combined.

In addition, some fields in the 2016 table were not present in 2018 (and vice
versa). The `num_transitpass` field kept track of how many transit passes the
person used per week in 2016. This field was dropped in 2018. While several
fields were dropped, none were critical to model estimation.

```{r combine_persons}
# combine persons

# # Check for field discrepancies
# bind_rows(
#   per_2016_raw %>% mutate(year = 2016),
#   per_2018_raw %>% mutate(year = 2018)
# ) %>%
#   group_by(year) %>%
#   summarize_all(~sum(is.na(.))) %>%
#   View()

prep_per_2016 <- per_2016_raw %>%
  mutate(
    race = case_when(
      race == 1 ~ "Asian",
      race == 2 ~ "Black",
      race == 3 ~ "White",
      race == 4 ~ "Other",
      race == 5 ~ "Other",
      race == 6 ~ "Noanswer"
    )
  ) %>%
  rename(
    hhid = hhID,
    personid = personID,
    personnum = personNum,
    worker_earnings = worker_income,
    numtrips = num_trips
  ) %>%
  # remove fields that weren't collected in 2018
  select(-c(
    num_transitpass:work_transit, walk_freq,
    hhweight, person_weight_final,
    smartphone_iphone, smartphone_android, android_age
  )) %>%
  mutate(year = 2016)

prep_per_2018 <- per_2018_raw %>%
  select(-c(
    segment:home_loc_region,
    school_taz, school_region,
    work_taz_1, work_region_1, work_taz_2, work_region_2,
    secondhome_taz, secondhome_region,
    hh_income_cat, hh_weight_combined, diary_order, copied_trips_available,
    copied_trips_confirmed, user_ismobiledevice, education_flag,
    school_mode_flag, hh_weight_2018
  )) %>%
  # handle other fields
  mutate(
    personid = as.character(personid),
    year = 2018
  )

# collapse race fields into a single column
race_collapse <- prep_per_2018 %>%
  select(personid, race_asian:race_noanswer) %>%
  mutate(race_noanswer = ifelse(is.na(race_noanswer), 1, race_noanswer)) %>%
  pivot_longer(
    cols = race_asian:race_noanswer,
    names_to = "race"
  ) %>%
  filter(!is.na(value)) %>%
  group_by(personid) %>%
  # Collapse 2+ races into "other"
  mutate(
    race_count = sum(value),
    value = ifelse(race_count > 1, 0, value),
    value = ifelse(race_count > 1 & race == "race_other", 1, value)
  ) %>%
  filter(value == 1) %>%
  mutate(
    race = gsub("race_", "", race),
    race = str_to_title(race)
  ) %>%
  select(-value, -race_count)

prep_per_2018 <- prep_per_2018 %>%
  left_join(race_collapse, by = "personid") %>%
  select(-c(race_asian:race_noanswer))

# combine and remove person records for households without hhweight
per_combined <- bind_rows(
  prep_per_2016,
  prep_per_2018
) %>%
  left_join(
    hh_add_choice_markets %>% select(hhid, hh_weight_combined),
    by = "hhid"
  ) %>%
  filter(!is.na(hh_weight_combined))
```

```{r}
per_add_flags <- per_combined %>%
  mutate(
    is_senior = ifelse(age_category >= 10, 1, 0),
    is_senior = replace_na(is_senior, 0),
    is_child = ifelse(age_category <= 4, 1, 0),
    is_child = replace_na(is_child, 0),
    is_worker = ifelse(employment <= 3, 1, 0),
    is_worker = replace_na(is_worker, 0)
  )

hh_add_seniors <- hh_add_choice_markets %>%
  left_join(
    per_add_flags %>%
      group_by(hhid) %>%
      summarize(num_seniors = sum(is_senior, na.rm = TRUE)),
    by = "hhid"
  ) %>%
  mutate(
    num_seniors = replace_na(num_seniors, 0),
    senior_in_hh = ifelse(num_seniors > 0, 1, 0),
  )
```


### Trip table

Similar to the person table, the trip tables from 2016 and 2018 contained
different fields and field definitions, which complicated the combination
process. Importantly, the definition of activity purpose changed slightly
between the two years. Both columns were left in the combined table, to be
processed in the next step.

```{r combine_trips}
prep_trip_2016 <- trips_2016_raw %>%
  mutate(
    year = 2016,
    personNum = str_pad(personNum, 2, "left", "0"),
    hhID = as.character(hhID),
    personid = paste0(hhID, personNum),
    tripNum = str_pad(tripNum, 3, "left", "0"),
    tripid = paste0(hhID, personNum, tripNum),
    mode = case_when(
      mode == 1 ~ "own_car",
      mode == 2 & mode_othauto == 1 ~ "work_car",
      mode == 2 & mode_othauto == 2 ~ "rental_car",
      mode == 2 & mode_othauto %in% 3:4 ~ "friends_car",
      mode == 2 & mode_othauto == 5 ~ "carshare",
      mode == 2 & mode_othauto == 6 ~ "taxi",
      mode == 2 & mode_othauto == 7 ~ "tnc",
      mode == 2 & mode_othauto == 8 ~ "vanpool",
      mode == 2 ~ "other_auto",
      mode == 3 & mode_bus %in% c(1, 2, 5) ~ "bus",
      mode == 3 & mode_bus %in% 3:4 ~ "school_bus",
      mode == 3 & mode_bus == 6 ~ "shuttle",
      mode == 3 & mode_bus == 7 ~ "vanpool",
      mode == 3 & mode_bus == 8 ~ "paratransit",
      mode == 3 ~ "other_bus",
      mode == 4 ~ "walk",
      mode == 5 ~ "bike",
      mode == 6 ~ "other"
    )
  ) %>%
  rename(
    hhid = hhID, personnum = personNum, tripnum = tripNum,
    o_activity_2016 = o_activity, d_activity_2016 = d_activity,
    vehiclenum = vehicleNum
  ) %>%
  select(-c(
    tripweight1:tripweight4,
    o_activity_derived, d_activity_derived, tollroad_cost, 
    tollroad_cost_dontknow, trip_flag, gpsfact_age, gpsfact_inc, gpsfact_purp
  ))

prep_trip_2018 <- trips_2018_raw %>%
  mutate(
    year = 2018,
    hhid = as.character(hhid),
    personnum = as.character(personnum),
    personid = str_pad(personid, 2, "left", "0"),
    tripnum = str_pad(tripnum, 3, "left", "0"),
    tripid = as.character(tripid),
    mode = case_when(
      mode == 1 ~ "own_car",
      mode == 2 & mode_othauto == 1 ~ "work_car",
      mode == 2 & mode_othauto == 2 ~ "rental_car",
      mode == 2 & mode_othauto %in% 3:4 ~ "friends_car",
      mode == 2 & mode_othauto == 5 ~ "carshare",
      mode == 2 & mode_othauto == 6 ~ "taxi",
      mode == 2 & mode_othauto == 7 ~ "tnc",
      mode == 2 & mode_othauto == 8 ~ "vanpool",
      mode == 2 ~ "other_auto",
      mode == 3 & mode_bus %in% c(1, 2, 4) ~ "bus",
      mode == 3 & mode_bus == 3 ~ "school_bus",
      mode == 3 & mode_bus == 5 ~ "shuttle",
      mode == 3 & mode_bus == 6 ~ "vanpool",
      mode == 3 & mode_bus == 7 ~ "paratransit",
      mode == 3 ~ "other_bus",
      mode == 4 ~ "walk",
      mode == 5 ~ "bike",
      mode == 6 ~ "other"
    )
  ) %>%
  select(-c(
    last_trip, segment, origin_taz, origin_campus, origin_region,
    destination_taz, destination_campus, destination_region,
    departure_string, arrival_string, o_activity_itre, o_activity_final,
    d_activity_itre, d_activity_final,
    quality_flag, trip_weight_2018
  )) %>%
  rename(o_activity_2018 = o_activity, d_activity_2018 = d_activity)

trip_combined <- bind_rows(
  prep_trip_2016,
  prep_trip_2018
) %>%
  mutate(
    hhid = as.numeric(hhid),
    personnum = as.numeric(personnum),
    tripnum = as.numeric(tripnum),
    seqtripid = seq(from = 1, to = n(), by = 1)
  ) %>%
  select(hhid, personid, tripid, personnum, tripnum, seqtripid, everything()) %>%
  left_join(
    per_add_flags %>% select(personid, age, is_child, is_senior, is_worker, school),
    by = "personid"
  ) %>%
  mutate(party_size = num_hh_members + num_nonhh) %>%
  left_join(
    hh_add_seniors %>% select(hhid, hh_weight_combined),
    by = "hhid"
  ) %>%
  filter(!is.na(hh_weight_combined))
```

## Basic checks

A common task in household survey processing is to remove households for various
reasons. For instance, travel models estimate weekday travel, so households
surveyed on the weekend must be removed. Households may have incomplete travel
diaries, be located outside the model region, or have other issues that requires
removal from the estimation data set. This section documents that process and
the removal of specific data records.

### Day of week

Due to careful survey design, none of the Triangle households were surveyed
on the weekend. The chart below shows the days surveyed (1 is Monday).

```{r}
temp <- hh_add_seniors %>%
  group_by(year, travelday) %>%
  summarize(samples = n())

ggplot(temp, aes(x = travelday, y = samples, fill = as.factor(travelday))) +
  geom_bar(stat = "identity") +
  guides(fill = FALSE) +
  facet_wrap(~year)
```

Starting in 2018, the survey process was modified to only collect travel diaries
in the middle of the week, excluding travel on Monday and Friday. These days
often display differences in trip rates as compared to the other days of the
week, perhaps due to .holidays, vacations, alternative work schedules, or other
reasons. The hypothesis of differences in trip rates on Monday and Friday as
compared to mid-week travel (Tuesday through Thursday) was evaluated by applying
a t-test to the average trip rate per household for each day of week category.
The result suggests that trip making shows no significant difference between the
day of week categories, leading to the decision to retain all surveyed
households in the estimation data set.

```{r}
# Compare Friday to not Friday
t.test(
  hh_add_seniors$num_trips[hh_add_seniors$travelday %in% c(1,5)],
  hh_add_seniors$num_trips[!(hh_add_seniors$travelday %in% c(1,5))],
  var.equal = TRUE # if false then performs Welch's t-test
) %>%
  tidy() %>%
  # rename(`mean T-Th` = estimate1, `M & F` = estimate2) %>%
  select(estimate1:p.value) %>%
  pivot_longer(
    cols = estimate1:p.value, names_to = "Parameter", values_to = "Value"
  ) %>%
  mutate(
    Parameter = c(
      "Average Trips/HH (Mon/Fri)",
      "Average Trips/HH (Midweek)",
      "t-stat",
      "p.value"
    )
  ) %>%
  kable(digits = 2) %>%
  kable_styling(full_width = FALSE)
```

### Household locations

It is also important to make sure that only households in the model region are
used for estimation. This ensures that the model reflects the travel patterns
that make the Triangle unique. The map below shows the locations of all
households included in the survey. Each falls within the model boundary, and no
households had to be dropped.

```{r}
shp <- hh_add_seniors %>%
  select(home_loc_lat, home_loc_lng) %>%
  st_as_sf(
    coords = c("home_loc_lng", "home_loc_lat"), crs = 4326, agr = "constant"
  )
boundary_shp <- st_read(
  "data/input/model_boundary/boundary 2020-11-02.shp",
  quiet = TRUE
)
boundary_shp <- st_transform(boundary_shp, st_crs(shp))
bbox <- as.list(st_bbox(boundary_shp))
lng <- (bbox$xmin - bbox$xmax) / 2 + bbox$xmax
lat <- (bbox$ymax - bbox$ymin) / 2 + bbox$ymin

leaflet(
  options = leafletOptions(zoomControl = FALSE, minZoom = 9, maxZoom = 9)
) %>%
  addTiles() %>%
  addPolygons(
    data = boundary_shp,
    color = "#444444", weight = 1, smoothFactor = 0.5
  ) %>%
  addCircleMarkers(
    data = shp, radius = 1, weight = 3,
    opacity = .2, fillOpacity = .2
  ) %>%
  setView(lng, lat, zoom = 9)
```

### Incomplete records

Travel surveys such as the [National Household Travel
Survey](https://nhts.ornl.gov/) include households where only half of the
household members filled out a travel diary. These households cannot be used in
estimation for certain sub models (e.g. trip production), because the household
reports fewer trips than what actually took place. Looking at the survey data
cannot determine if people failed to fill out a travel diary; they may have
simply taken no trips on the survey day. Instead, the survey documentation from
RSG reports that only fully-reported households were included in the data set.

### Survey weights

It is important to check the weighting and expansion of a survey for extreme
weight values. A large weight indicates that they survey failed to collect
adequate samples from a specific segment of the population, which can bias model
estimation and lead to poor predictive power. To check the weights, they must
first be normalized based on the expected average weight per sample. A simple
comparison of two hypothetical surveys explains why:

1. A survey with 100 samples of a population of 100,000: Average weight = 1,000
2. A survey with 1000 samples of a population of 100,000: Average weight = 100

A household weight of 1,000 in the first survey is reasonable based on the
number of samples, but it is 10 times the expected weight in the second survey.
For the 2016+2018 combined survey, the average weight is shown below.

```{r}
temp <- hh_add_seniors %>%
  group_by(year) %>%
  summarize(
    Samples = n(),
    `Total Households` = round(sum(hh_weight_combined), 0),
  )
totals <- temp %>%
  ungroup() %>%
  mutate(across(everything(), sum)) %>%
  mutate(year = "Total") %>%
  slice(1)
temp2 <- bind_rows(
  temp %>%
    mutate(year = as.character(year)),
  totals
) %>%
  mutate(
    `Average Weight` = `Total Households` / Samples,
    Samples = format(Samples, big.mark = ","),
    `Total Households` = format(`Total Households`, big.mark = ",")
  ) %>%
  rename(Year = year)


weight_mean <- mean(hh_add_seniors$hh_weight_combined)

temp2 %>%
  kable(digits = 0, align = "lrrr") %>%
  kable_styling(full_width = FALSE)
```

The first histogram below shows the distribution of weights divided by the mean
weight. While the largest weight is 15x the mean weight, this is an outlier and
most are within 6x. This is a reasonable result and indicates a well-designed
sample plan that collected a representative number of households in all the
demographic groups of interest.

```{r}
ggplot(hh_add_seniors, aes(x=hh_weight_combined / weight_mean)) + 
  geom_histogram(color="black", fill="orange", bins = 10) +
  xlab("Weight / Average Weight")
```

The histogram above is good for identifying weights that are too large, but does
not help identify those that are very small. Small weights are not problematic
like large weights, but they imply oversampling of a target demographic, which
could inform future collection efforts. The second histogram below inverts the
factor above and divides the average weight by the individual household weights.
Large numbers in this histogram would indicate the presence of small weights.
The smallest weight (17.3) is 14% of the average weight (1 / .14 = 7.14 in the
histogram below). This suggests a modest over sample, but well within reason.

```{r}
ggplot(hh_add_seniors, aes(x= weight_mean/ hh_weight_combined)) + 
  geom_histogram(color="black", fill="orange", bins = 10) +
  xlab("Average Weight / Weight")
```

After a review of the RSG expansion procedure combined with the review of
weights described above, Caliper determined that the weights were appropriate
for use in model estimation.

### Income imputation

The survey provides income at two levels of aggregation: 10 categories or 5. RSG
imputed incomes for the broad category in order to use ACS income information
during survey expansion. The imputation:

  1. Further stratified category 5 (\$100k+) into those above and below \$150k.
  2. Imputed incomes for those households that did not report.
  
In order to preserve all the records in the survey, the Caliper team used the
imputed, broad categories of income. The table below shows the count of samples
by the original and imputed categories.

```{r}
temp_broad <- bind_rows(
  remove_na_2016 %>%
    select(hh_income_broad),
  remove_na_2018 %>%
    select(hh_income_broad)
) %>%
  group_by(hh_income_broad) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  rename(Original = hh_income_broad, count1 = count)

df <- bind_cols(
  temp_broad,
  hh_add_seniors %>%
    group_by(hh_income_broad) %>%
    summarize(count = n()) %>%
    ungroup() %>%
    rename(Imputed = hh_income_broad, count2 = count)
)
colnames(df) <- c("Original", "Count", "Imputed", "Count")
df$Original <- c(
  "Under $25,000",
  "$25,000-$49,999",
  "$50,000-$74,999",
  "$75,000-$99,999",
  "$100,000 or more",
  "Prefer not to answer"
)
df$Imputed <- c(
  "Under $25,000",
  "$25,000-$49,999",
  "$50,000-$74,999",
  "$75,000-$99,999",
  "$100,000-$149,999",
  "$150,000 or more"
)

df[,1:2] %>%
  kable() %>%
  kable_styling(full_width = FALSE)

df[,3:4] %>%
  kable() %>%
  kable_styling(full_width = FALSE)
```

A full discussion of their income imputation can be found in the survey
documentation. They used ordinal logistic regression to predict income
categories based on household features like size and number of workers (among
others).

## Trip processing

Trip processing for the TRMG2 departs from the common approach of
categorizing trips by trip purpose. Instead, trips are categorized by

- Tour Type: Whether the trip takes place on a work or non-work tour.
- Homebased: Whether one end of the trip is home or not.
- Activity: What the person does after making the trip (similar to traditional
  trip purpose)
- Duration: How long the person spends at their destination.

These new classifications provide more insight into travel behavior compared to
traditional trip purposes. A simple example would be to compare non-home-based
(NHB) trips made on a work tour or a non-work tour. On a work tour, NHB trips
are likely to be dropping off kids, picking up groceries, or getting gas. On
non-work tours, NHB stops are more likely to be for things like shopping,
dining, etc. This is why NHB trips are typically stratified into NHBW (where one
end is work) and NHBO (where neither end is work). However, if a person drops
off a child at school and then gets gas on their way to work, the traditional
treatment would classify the trip from school to the gas station as NHBO and
lose the understanding that it was actually part of a work tour.

The following sections provide more detail.

*TODO: add more intro/why*

### Activity types

As described above, the activity type describes what the activities a person is
performing throughout the day. The survey provides many categories for activity
type, but the Caliper collapsed them into the types shown below.

- H: Home (non-work activities at home)
- W: Work
- WR: Work-related (e.g. making a delivery)
- PreK: Attend school (Pre-Kindergarten)
- K12: Attend school (Kindergarten through 12th grade)
- U: Attend school (University or College)
- SHP: Shop
- EAT: Dining out
- PU: Pick up
- DO: Drop off
- X: Transfer modes (e.g. at a bus stop)
- OM: Other maintenance 
- OMED: Other medical
- OD: Other discretionary

The table below shows how the activity types (for both years) were collapsed
into the types above.

```{r, include=FALSE}
activity_2016 <- read_csv("data/input/survey_processing/activity_2016.csv")
activity_2018 <- read_csv("data/input/survey_processing/activity_2018.csv")
```

```{r}
temp <- activity_2016 %>%
  left_join(activity_2018, by = "code") %>%
  rename(
    `Activity Code` = code,
    `2016 Description` = activity_long.x,
    `2016 Equivalence` = activity.x,
    `2018 Description` = activity_long.y,
    `2018 Equivalence` = activity.y
  )

temp[,1:3]%>%
  kable() %>%
  kable_styling(
    bootstrap_options = "striped",
    full_width = FALSE
  )

temp[,c(1, 4, 5)]%>%
  kable() %>%
  kable_styling(
    bootstrap_options = "striped",
    full_width = FALSE
  )
```

```{r activity_purpose}
act_to_join_2016 <- activity_2016 %>% select(-activity_long)
act_to_join_2018 <- activity_2018 %>% select(-activity_long)

convert_purpose <- trip_combined %>%
  left_join(act_to_join_2016, by = c("o_activity_2016" = "code")) %>%
  rename(o_activity1 = activity) %>%
  left_join(act_to_join_2016, by = c("d_activity_2016" = "code")) %>%
  rename(d_activity1 = activity) %>%
  left_join(act_to_join_2018, by = c("o_activity_2018" = "code")) %>%
  rename(o_activity2 = activity) %>%
  left_join(act_to_join_2018, by = c("d_activity_2018" = "code")) %>%
  rename(d_activity2 = activity) %>%
  mutate(
    o_activity = ifelse(is.na(o_activity1), o_activity2, o_activity1),
    d_activity = ifelse(is.na(d_activity1), d_activity2, d_activity1),
  ) %>%
  select(
    -c(o_activity1:d_activity2), -o_activity_2016, -o_activity_other,
    -d_activity_2016, -d_activity_other, -o_activity_2018, -d_activity_2018
  ) %>%
  mutate(
    # some people marked 1-yo old as student with school at home. Not what
    # we are interested in.
    # student_type = ifelse(is.na(school), 0, 1),
    student_type = case_when(
      school >= 4 & school <= 9 ~ "K12",
      school >= 10 & school <= 13 ~ "U",
      !is.na(school) ~ "PreK",
      TRUE ~ ""
    ),
    o_activity = case_when(
      o_activity != "SCH" ~ o_activity,
      student_type != "" ~ student_type,
      TRUE ~ "SCH?"
    ),
    d_activity = case_when(
      d_activity != "SCH" ~ d_activity,
      student_type != "" ~ student_type,
      TRUE ~ "SCH?"
    ),
    homeschooled_flag = ifelse(school %in% c(5, 7, 9), 1, 0)
  )

# A departure time of 0 is 3:00 am. Anything before that is -60.
# Change it to be minutes from midnight.
change_time <- convert_purpose %>%
  mutate(across(
    c(departure_time, arrival_time),
    ~ifelse(.x == -60, 0, .x + 180)
  ))
```

### Place codes

Caliper computed a place code for every trip end independent of activity. These
simply describe where the activity took place.

- H: Home
- W: Work
- S: School
- O: Other

The large majority of respondents entered "HOME" for the place name when a trip
end was at home (as instructed by the survey). Assigning an "H" place code for
these records was easy. However, some place names in the trip file were more
challenging. Some respondents confused place name and activity in their
responses. For example, several provided "walk dog" or "went home" for place
name. 

In these cases, the location of the activity was used to help identify home
locations. Regardless of place name, if a trip end was the exact same location
as home, the place was marked as home. If the trip end was within 10 meters of
home and the place name contained some keywords (e.g. "home", "dog", "mailbox"),
it was also marked as home.

Determining school locations present a slightly different challenge. There
wasn't as much consistency in place naming compared to the standard "home".
Instead, people responded with "school", "university", or often the name of
the school. Fortunately, the person file contained the school location for each
student (barring some missing values). If the trip end address was the same 
as the person's school, it was marked as school.

Work locations presented a further challenge. Not only do people have
multiple jobs, but many had jobs without fixed work locations (e.g. nanny). For
this reason, Caliper relied on the stated activity purpose to determine work
places. Work from home activities had a place code of home.

```{r determine_place}
# Use calculated distances (rather than just place names) to help determine trip
# end place type (H, W, S(chool), O)
calc_dist <- function(x1, y1, x2, y2) {
  df1 <- tibble(lng = x1, lat = y1)
  df2 <- tibble(lng = x2, lat = y2)
  distHaversine(df1, df2)
}

home_words <- paste(
  "walk",
  "house",
  "dog",
  "mailbox",
  "shed",
  "home",
  "hone", # misspelling of home
  sep = "|"
)


det_home_place <- change_time %>%
  # Home
  left_join(
    hh_add_seniors %>% select(hhid, home_loc_lat, home_loc_lng),
    by = "hhid"
  ) %>%
  mutate(
    o_home_dist = calc_dist(
      origin_lng, origin_lat, home_loc_lng, home_loc_lat),
    d_home_dist = calc_dist(
      destination_lng, destination_lat, home_loc_lng, home_loc_lat),
    # o_place = ifelse(o_home_dist < 100, "H", "O"),
    o_place = case_when(
      o_home_dist == 0 ~ "H",
      o_home_dist <= 10 & grepl(home_words, origin_name) ~ "H",
      TRUE ~ "O"
    ),
    o_place = ifelse(is.na(o_place), "O", o_place),
    o_place = ifelse(origin_name == "HOME", "H", o_place),
    d_place = case_when(
      d_home_dist == 0 ~ "H",
      d_home_dist <= 10 & grepl(home_words, destination_name) ~ "H",
      TRUE ~ "O"
    ),
    d_place = ifelse(is.na(d_place), "O", d_place),
    d_place = ifelse(destination_name == "HOME", "H", d_place)
  ) %>%
  select(-home_loc_lat, -home_loc_lng)

non_home_problems <- det_home_place %>%
  filter(
    (o_activity == "H" & o_place != "H") |
      (d_activity == "H" & d_place != "H")
  ) %>%
  nrow()  
  
    # correct home activities that don't happen at home
fix_home_activities <- det_home_place %>%
  mutate(
    o_activity = ifelse(o_activity == "H" & o_place != "H", "OD", o_activity),
    d_activity = ifelse(d_activity == "H" & d_place != "H", "OD", d_activity)
  )

school_loc <- per_add_flags %>%
  select(hhid, personid, school_address, school_lat, school_lng) %>%
  left_join(
    hh_add_seniors %>% select(hhid, home_loc_address),
    by = "hhid"
  ) %>%
  filter(!is.na(school_lat) & home_loc_address != school_address) %>%
  select(-hhid, -home_loc_address)

det_sch_place <- fix_home_activities %>%
  left_join(school_loc, by = "personid") %>%
  mutate(
    o_sch_dist = calc_dist(origin_lng, origin_lat, school_lng, school_lat),
    d_sch_dist = calc_dist(
      destination_lng, destination_lat, school_lng, school_lat),
    o_place = case_when(
      is.na(o_sch_dist) ~ o_place,
      o_place == "H" ~ "H",
      origin_address == school_address ~ "S",
      TRUE ~ o_place
    ),
    d_place = case_when(
      is.na(d_sch_dist) ~ d_place,
      d_place == "H" ~ "H",
      destination_address == school_address ~ "S",
      TRUE ~ d_place
    ),
    # Guess school places for students with missing school loc info
    o_place = ifelse(
      student_type != "" &
        is.na(school_address) &
        o_activity %in% c("PreK", "K12", "U") &
        o_place == "O" &
        str_detect(origin_name, "school"),
      "S", o_place
    ),
    d_place = ifelse(
      student_type != "" &
        is.na(school_address) &
        d_activity %in% c("PreK", "K12", "U") &
        d_place == "O" &
        str_detect(origin_name, "school"),
      "S", d_place
    )
  ) %>%
  select(-school_lng, -school_lat)

# Determining work place is harder. People have multiple jobs, and some jobs
# don't have fixed addresses. Rely on their reported activity.
det_work_place <- det_sch_place %>%
  mutate(
    o_place = case_when(
      o_place == "H" ~ "H",
      o_activity == "W" ~ "W",
      TRUE ~ o_place
    ),
    d_place = case_when(
      d_place == "H" ~ "H",
      d_activity == "W" ~ "W",
      TRUE ~ d_place
    )
  ) %>%
  relocate(o_place, .before = o_activity) %>%
  relocate(d_place, .after = o_place)
```

### Mode code simplification

The table below shows how the survey mode field was simplified. For the auto
mode, occupancy was used to split into single-occupancy (sov) and high-occupancy
(hov). Final are established in the mode choice documentation, but these are
used for the purpose of exploratory analysis later in this document.

```{r simplify_mode}
mode_equiv <- read_csv(
  "data/input/survey_processing/mode_equiv.csv",
  col_types = cols(
    code = col_character(),
    mode_simple = col_character()
  )
)

mode_equiv %>%
  rename(`Survey Mode` = code, `Model Mode` = mode_simple) %>%
  kable() %>%
  kable_styling(full_width = FALSE)

route_equiv <- read_csv(
  "data/input/survey_processing/route_equiv.csv",
  col_types = cols(
    transit_system_1 = col_double(),
    transit_line_1 = col_double(),
    transit_system_name = col_character(),
    transit_line_name = col_character(),
    rts_name1 = col_character(),
    rts_name2 = col_character(),
    bus_type = col_character()
  )
) %>%
  select(transit_system_1, transit_line_1, bus_type)

simplify_mode <- det_work_place %>%
  left_join(mode_equiv, by = c("mode" = "code")) %>%
  left_join(route_equiv, by = c("transit_system_1", "transit_line_1")) %>%
  mutate(
    mode_final = case_when(
      mode_simple == "auto_pay" ~ "auto_pay",
      mode_simple == "other_auto" ~ "other_auto",
      grepl("auto", mode_simple) & party_size == 1 ~ "sov",
      grepl("auto", mode_simple) & party_size == 2 ~ "hov2",
      grepl("auto", mode_simple) & party_size > 2 ~ "hov3",
      !is.na(bus_type) ~ bus_type,
      TRUE ~ mode_simple
    ),
    access_mode = case_when(
      transit_access %in% c(1, 2, 7) ~ "w",
      transit_access == 3 ~ "pnr",
      transit_access %in% 4:5 ~ "knr",
      transit_access == 6 ~ "xfer",
      transit_access == 8 ~ "other"
    ),
    egress_mode = case_when(
      transit_egress %in% c(1, 2, 7) ~ "w",
      transit_egress == 3 ~ "pnr",
      transit_egress %in% 4:5 ~ "knr",
      transit_egress == 6 ~ "xfer",
      transit_egress == 8 ~ "other"
    )
  )
```

The chart below shows the expanded trips by mode.

```{r}
temp <- simplify_mode %>%
  mutate(mode_final = ifelse(mode_final %in% c("eb", "lb"), "bus", mode_final)) %>%
  group_by(Mode = mode_final) %>%
  summarize(weight = sum(trip_weight_combined, na.rm = TRUE))
ggplot(data = temp, aes(
  x = reorder(Mode, -weight), y = weight, fill = Mode,
  label = format(weight, big.mark = ",", digits = 0)
)) +
  geom_col(show.legend = FALSE) +
  geom_text(nudge_y = 100000, color = "black") +
  labs(
    title = "Trips by Mode",
    x = "Mode",
    y = "Weighted Trips"
  ) +
  theme(plot.title = element_text(hjust = 0.5))
```

### Tour formation

While the TRMG2 is a trip-based model, the production rates and other estimated
behavior can still make use of tour information to improve predictive power and
accuracy. At the same time, the trip-based formulation means that tour formation
is much simpler. Rather than requiring detailed tour information to support
coordinated activity patterns within a household (as in activity-based models),
tours can be classified simply as work or non-work.

For example, for each person in the survey, a tour begins with their first trip
and ends when they return home. A second tour starts if they leave home again.
Most tours are classified as work if the traveler has a work activity during the
tour. If they do not, then the tour is classified as non-work. A small number of
tours have a work activity during the tour, but the duration of that activity is
short (less than 2 hours) or they spend twice as long somewhere else as at work.
These tours are classified as non-work.

There is a third tour type ("home"), that handles cases where the survey reports
trips within the home. For example, some respondents report being at home and
then working from home as a trip (other respondents do not). Home tours also
capture things like recreational walks that start and end at the home. For the
purpose of travel modeling, these home tours are ignored in TRMG2; however, this
segmentation scheme would allow for the addition of non-motorized "loop" tours
without any reported stops for improved non-motorized trip modeling in a future
version of the model without requiring any changes to the existing trip
purposes.

```{r tour_formation}
determine_tours <- simplify_mode %>%
  group_by(personid) %>%
  mutate(
    new_tour = ifelse(row_number() == 1, 1, 0),
    new_tour = ifelse(o_place == "H", 1, new_tour),
    tour_num = cumsum(new_tour)
  ) %>%
  group_by(personid, tour_num) %>%
  mutate(
    trips_in_tour = n(),
    tour_distance = sum(distance),
    tour_duration = last(arrival_time) - first(departure_time),
    tour_anchor = ifelse(d_activity == "W" & d_place != "H", "W", ""),
    tour_anchor = ifelse(o_place == "H" & d_place == "H", "H", tour_anchor),
    tour_type = case_when(
      "W" %in% tour_anchor ~ "W",
      "H" %in% tour_anchor ~ "H",
      TRUE ~ "N"
    ),
    o_party_size_change = party_size - lag(party_size),
    d_party_size_change = lead(party_size) - party_size,
    o_act_dur = departure_time - lag(arrival_time),
    d_act_dur = lead(departure_time) - arrival_time
  )

# loop trips are things like recreational walks
flag_loop_trips <- determine_tours %>%
  mutate(
    loop_flag = case_when(
      trips_in_tour > 2 ~ 0,
      d_act_dur > 10 ~ 0,
      !(mode %in% c("walk", "bike")) ~ 0,
      "walk" %in% origin_name ~ 1,
      "walk" %in% destination_name ~ 1,
      !(o_activity %in% c("H", "OD")) ~ 0,
      !(d_activity %in% c("H", "OD")) ~ 0,
      TRUE ~ 1
    )
  )
```

```{r}
# Flip work tours to non-work if time spent at work isn't the major component
# of the trip.
temp <- flag_loop_trips %>%
  filter(tour_type == "W", d_activity == "W") %>%
  group_by(personid, tour_num) %>%
  summarize(total_w_duration = sum(d_act_dur, na.rm = TRUE))

temp2 <- flag_loop_trips %>%
  filter(tour_type == "W") %>%
  group_by(personid, tour_num) %>%
  mutate(
    max_o_duration = max(replace_na(d_act_dur, 0), na.rm = TRUE)
  ) %>%
  filter(d_act_dur == max_o_duration & d_activity != "W") %>%
  slice(1) %>%
  left_join(temp, by = c("personid", "tour_num")) %>%
  select(personid, tour_num, d_activity, max_o_duration, total_w_duration) %>%
  mutate(flip_to_nt = case_when(
    d_activity == "WR" ~ 0,
    total_w_duration < 120 ~ 1,
    max_o_duration > 2 * total_w_duration ~ 1,
    TRUE ~ 0
  )) %>%
  select(personid, tour_num, flip_to_nt)

flip_to_nt <- flag_loop_trips %>%
  left_join(temp2, by = c("personid", "tour_num")) %>%
  mutate(flip_to_nt = replace_na(flip_to_nt, 0)) %>%
  group_by(personid, tour_num) %>%
  mutate(tour_type = ifelse(flip_to_nt == 1, "N", tour_type))
```


### Data cleaning

```{r}
num_sch_problems <- flip_to_nt %>%
  mutate(
    sch_flag = case_when(
      o_activity == "SCH?" ~ 1,
      d_activity == "SCH?" ~ 1,
      TRUE ~ 0
    )
  ) %>%
  filter(sch_flag == 1) %>%
  nrow()
```

```{r clean_sch_probs}
# This key uniquely identifies trips in a way that isn't person specific. This
# lets you identify all the trip records that went on the same trip. Great for
# HOV analysis.
add_key <- flip_to_nt %>%
  ungroup() %>%
  unite(
    key, hhid, origin_address, departure_time, destination_address,
    arrival_time,
    remove = FALSE
  )

# check to see how many missing joint trips there are. i.e other hh members
# report hh member 3 was on the trip, but hh member 3 doesn't have that trip
# listed.
temp <- add_key %>%
  select(key, num_hh_members) %>%
  group_by(key) %>%
  mutate(count = n()) %>%
  slice(1)
num_missing_joint_trips <- sum(temp$num_hh_members) - sum(temp$count)
remove(temp)

# this checks to see if anyone in the trip had school as origin/dest place.
# Drop off trips with school trips often take longer (e.g. waiting for the
# bus or carpool).
s_check <- add_key %>%
  select(key, o_place, d_place) %>%
  group_by(key) %>%
  mutate(
    o_s_check = ifelse(any(str_detect(o_place, "S")), 1, 0),
    d_s_check = ifelse(any(str_detect(d_place, "S")), 1, 0)
  ) %>%
  summarize(
    o_s_check = max(o_s_check),
    d_s_check = max(d_s_check)
  )

add_s_check <- add_key %>%
  left_join(s_check, by = "key") %>%
  group_by(personid, tour_num) %>%
  mutate(
    d_s_check = ifelse(lead(o_s_check) == 1, 1, d_s_check),
    o_s_check = ifelse(lag(d_s_check) == 1, 1, o_s_check),
    d_s_check = ifelse(is.na(d_s_check), 0, d_s_check),
    o_s_check = ifelse(is.na(o_s_check), 0, o_s_check)
  )


# Use logic to identify pu/do trips. Many of the SCH? activities are actually
# pu/do.
fix_pudo <- add_s_check %>%
  mutate(
    # flag trips where the logic identifies DO before changing purpose
    d_do_flag = case_when(
      d_party_size_change >= 0 ~ 0,
      d_act_dur <= 10 ~ 1,
      d_act_dur <= 25 & d_s_check == 1 ~ 1,
      TRUE ~ 0
    ),
    d_activity = ifelse(d_do_flag == 1, "DO", d_activity),
    o_activity = case_when(
      is.na(lag(d_do_flag)) ~ o_activity,
      lag(d_do_flag) == 1 ~ "DO",
      TRUE ~ o_activity
    ),
    d_pu_flag = case_when(
      d_party_size_change <= 0 ~ 0,
      d_act_dur <= 10 ~ 1,
      d_act_dur <= 25 & o_s_check == 1 ~ 1,
      TRUE ~ 0
    ),
    d_activity = ifelse(d_pu_flag == 1, "PU", d_activity),
    o_activity = case_when(
      is.na(lag(d_pu_flag)) ~ o_activity,
      lag(d_pu_flag) == 1 ~ "PU",
      TRUE ~ o_activity
    ),
    # Differentiate PU/DO at school from other
    d_activity = ifelse(
      d_activity %in% c("PU", "DO") & d_s_check == 1,
      paste0(d_activity, "S"), d_activity
    ),
    o_activity = case_when(
      is.na(lag(d_activity)) ~ o_activity,
      lag(d_activity) %in% c("PUS", "DOS") ~ paste0(o_activity, "S"),
      TRUE ~ o_activity
    )
  ) %>%
  select(-c(o_s_check:d_pu_flag))

fix_remaining_sch <- fix_pudo %>%
  mutate(
    o_activity = ifelse(o_activity == "SCH?" & o_place == "H", "H", o_activity),
    o_activity = ifelse(o_activity == "SCH?", "OD", o_activity),
    o_activity = case_when(
      o_activity %in% c("K12", "PreK") & age > 18 ~ "U",
      o_activity == "U" & age <= 17 & age > 5 ~ "K12",
      o_activity == "U" & age <= 5 ~ "PreK",
      TRUE ~ o_activity
    ),
    d_activity = ifelse(d_activity == "SCH?" & d_place == "H", "H", d_activity),
    d_activity = ifelse(d_activity == "SCH?", "OD", d_activity),
    d_activity = case_when(
      d_activity %in% c("K12", "PreK") & age > 18 ~ "U",
      d_activity == "U" & age <= 17 & age > 5 ~ "K12",
      d_activity == "U" & age <= 5 ~ "PreK",
      TRUE ~ d_activity
    ),
  )
```

```{r clean_bus_probs}
# School kids going to bus stops are not handled consistently. Fix them.
fix_bus <- fix_remaining_sch %>%
  mutate(
    bus_flag = ifelse(
      str_detect(tolower(destination_name), "bus") &
        !str_detect(tolower(destination_name), "business") &
        mode != lead(mode) &
        d_activity %in% c("PreK", "K12", "U"),
      1, 0
    ),
    d_activity = ifelse(bus_flag == 1, "X", d_activity),
    o_activity = case_when(
      is.na(lag(d_activity)) ~ o_activity,
      lag(d_activity) == "X" ~ "X",
      TRUE ~ o_activity
    )
  ) %>%
  select(-bus_flag)
```

The collection of travel behavior survey data is a challenging task and problems
can arise in the data due to a number of factors that can either be attributed
to respondent coding errors, data reporting errors, or survey design issues.
Caliper performed various logic checks on the data to identify systematic issues
with the data that required cleaning before the final estimation data set
could be created. These include:

- School activities reported by non-students (`r num_sch_problems` trips)
  - Pickup/Dropoff coded as school (300 trips)
  - Bus stops coded as school rather than mode transfer (70 trips)
- Missing joint trips (`r num_missing_joint_trips`). 
  -  (e.g., a trip references two hh members but second member doesn't have that
     trip record)
- Kids marked as homeschool but go to traditional school on travel day for
  school activity (30)
- Students without school address in person file (195)
- Home activities reported at non-home locations (e.g. "In-laws house") 
  (`r non_home_problems`)

These issues were identified and the data cleaned such that each person's trip
diary was internally logically consistent with itself and externally consistent
with the diaries of other household members.

### Trip linking

The way the TRMG2 model classifies trips (by including tour information) greatly
reduces the importance of trip linking. In traditional models, a stop to get gas
on the way to work is ignored. Rather than two trips (to the gas station and to
work), the trips are linked together into a single work trip. By classifying
trips by tour type, the TRMG2 retains the knowledge that both trips occur on the
way to work. This allows us to model them separately from other non-home-based
trips without needing to link them together.

For this model, trip linking was only performed to remove mode transfers at bus
stops. The survey treated parking location as an attribute of the trip rather
than an origin or destination, which meant no processing was required, rather
linking for this mode transfer was included in the delivered survey data.

```{r link_out_bus}
bus_flag <- fix_bus %>%
  mutate(
    bus_flag = case_when(
      o_activity != "X" & d_activity != "X" ~ 0,
      str_detect(tolower(destination_name), "bus") &
        !str_detect(tolower(destination_name), "business") ~ 1,
      str_detect(tolower(origin_name), "bus") &
        !str_detect(tolower(origin_name), "business") ~ 1,
      str_detect(tolower(destination_name), "transit") ~ 1,
      str_detect(tolower(origin_name), "transit") ~ 1,
      TRUE ~ 0
    )
  )

# Create a separate df of only the flagged trips. Collapse trip records on
# the same subtour into single trip records.
flagged_only  <- bus_flag  %>%
  filter(bus_flag == 1) %>%
  mutate(
    start_flag = ifelse(o_activity != "X" & d_activity == "X", 1, 0),
    end_flag = ifelse(o_activity == "X" & d_activity != "X", 1, 0),
    sub_tour = cumsum(start_flag)
  ) %>%
  group_by(personid, tour_num, sub_tour) %>%
  mutate(
    linked_modes = paste(unique(mode), collapse = " "),
    across(
      c(mode, num_hh_members:num_nonhh),
      ~ .x[duration == max(duration, na.rm = TRUE)][1]
    ),
    across(
      c(vehiclenum:taxi_cost_dontknow, park_lat, park_lng, year),
      ~ min(ifelse(is.na(.x), 999, .x), na.rm = TRUE)
    ),
    park_address = ifelse(
      length(first(park_address[!is.na(park_address)])) > 0,
      first(park_address[!is.na(park_address)]),
      NA
    ),
    across(
      c(vehiclenum:taxi_cost_dontknow, park_lat, park_lng, year),
      ~ ifelse(.x == 999, NA, .x)
    ),
    trip_weight_combined = mean(trip_weight_combined),
    speed_mph = round(distance / duration / 60, 0),
    across(
      starts_with(c("destination_", "d_", "arrival_time")),
      ~ last(.x)
    ),
    across(
      c("distance", "duration", "reported_duration"),
      ~ sum(.x)
    ),
    duration_string = paste0(
      str_pad(duration %/% 60, 2, "left", "0"),
      ":",
      str_pad(duration %% 60, 2, "left", "0")
    )
  ) %>%
  slice(1) %>%
  ungroup() %>%
  select(-c(bus_flag:sub_tour)) %>%
  mutate(linked_flag = 1)

xfer_linked_out <- bus_flag %>%
  filter(bus_flag == 0) %>%
  select(-bus_flag) %>%
  bind_rows(flagged_only) %>%
  arrange(hhid, personnum, tripnum) %>%
  relocate(linked_modes, .after = linked_flag) %>%
  mutate(linked_flag = ifelse(is.na(linked_flag), 0, linked_flag))
```

```{r}
# Create production/attraction fields
flip_to_pa <- xfer_linked_out %>%
  mutate(
    pa_flag = ifelse(d_place == "H", 0, 1),
    p_lng = ifelse(pa_flag == 1, origin_lng, destination_lng),
    a_lng = ifelse(pa_flag == 0, origin_lng, destination_lng),
    p_lat = ifelse(pa_flag == 1, origin_lat, destination_lat),
    a_lat = ifelse(pa_flag == 0, origin_lat, destination_lat),
    p_place = ifelse(pa_flag == 1, o_place, d_place),
    a_place = ifelse(pa_flag == 0, o_place, d_place),
    p_activity = ifelse(pa_flag == 1, o_activity, d_activity),
    a_activity = ifelse(pa_flag == 0, o_activity, d_activity),
    p_act_dur = ifelse(pa_flag == 1, o_act_dur, d_act_dur),
    a_act_dur = ifelse(pa_flag == 0, o_act_dur, d_act_dur),
    p_access_mode = ifelse(pa_flag == 1, access_mode, egress_mode),
    p_egress_mode = ifelse(pa_flag == 0, access_mode, egress_mode)
  )

# For mode choice estimation, create an integer field for modes.
# This needs to be done here to make sure access mode is considered in the PA
# direction.
mc_code <- flip_to_pa %>%
  mutate(mc_code = case_when(
    mode_final == "sov" ~ 1,
    mode_final == "hov2" ~ 2,
    mode_final == "hov3" ~ 3,
    mode_final == "lb" & access_mode == "w" ~ 4,
    mode_final == "lb" & access_mode == "knr" ~ 5,
    mode_final == "lb" & access_mode == "pnr" ~ 6,
    mode_final == "eb" & access_mode == "w" ~ 7,
    mode_final == "eb" & access_mode == "knr" ~ 8,
    mode_final == "eb" & access_mode == "pnr" ~ 9,
    mode_final == "auto_pay" ~ 10,
    mode_final == "other_auto" ~ 11,
    mode_final == "school_bus" ~ 12
  ))
  
```

### Geocoding and skims

A critical step in processing the survey trip table is to geocode the trip ends
to the model's zone system. This allows important model metrics like travel
impedance skims and socio-economic data to be associated with trip making
behavior.

The survey records include a lat/long pair for each origin, destination, and
parking location (if applicable). Each of these was used to append the
appropriate TRMG2 TAZ to the data record. Some of these locations fell outside
the model region and did not receive a TAZ ID. These trips will be ignored during
estimation of the internal resident trip models.

```{r, include=FALSE}
tazs <- st_read("data/input/tazs/master_tazs.shp") %>%
  st_transform(crs = st_crs('+proj=longlat +datum=WGS84'))
```


```{r}
# create unique list of lat/long points
pts <- tibble(
  lng = c(
    mc_code$origin_lng,
    mc_code$destination_lng,
    mc_code$park_lng,
    hh_add_seniors$home_loc_lng
  ),
  lat = c(
    mc_code$origin_lat,
    mc_code$destination_lat,
    mc_code$park_lat,
    hh_add_seniors$home_loc_lat
  ),
) %>%
  # unite(lng_lat, c(lng, lat), remove = FALSE) %>%
  group_by(lng, lat) %>%
  slice(1) %>%
  ungroup() %>%
  # select(-lng_lat) %>%
  filter(lng != "NA") %>%
  mutate(
    lng = as.numeric(lng),
    lat = as.numeric(lat)
  ) %>%
  st_as_sf(
    coords = c("lng", "lat"), 
    crs = st_crs(tazs),
    remove = FALSE
  )

# # manual check that they overlap
# library(leaflet)
# leaflet() %>%
#   addProviderTiles("Stamen.TonerLite") %>%
#   addPolygons(data = tazs) %>%
#   addMarkers(data = pts[2000:3000, ])
```

```{r, include=FALSE}
geocode_points <- pts %>%
  st_join(tazs %>% select(TAZ = ID)) %>%
  st_drop_geometry() %>%
  group_by(lng, lat) %>%
  slice(1) %>%
  ungroup()
```

```{r}
hh_update_taz <- hh_add_seniors %>%
  left_join(
    geocode_points,
    by = c("home_loc_lng" = "lng", "home_loc_lat" = "lat")
  ) %>%
  rename(G2_TAZ = TAZ)

add_taz_id <- mc_code %>%
  left_join(
    geocode_points,
    by = c("p_lng" = "lng", "p_lat" = "lat")
  ) %>%
  rename(p_taz = TAZ) %>%
  left_join(
    geocode_points,
    by = c("a_lng" = "lng", "a_lat" = "lat")
  ) %>%
  rename(a_taz = TAZ) %>%
  left_join(
    geocode_points,
    by = c("park_lng" = "lng", "park_lat" = "lat")
  ) %>%
  rename(park_taz = TAZ) %>%
  mutate(
    o_taz = ifelse(pa_flag == 1, p_taz, a_taz),
    d_taz = ifelse(pa_flag == 1, a_taz, p_taz)
  ) %>%
  relocate(o_taz:d_taz, .before = p_taz)
```


```{r}
# The full skim table is large (160MB). Instead of commit that to the
# repo, I did the join below first. I think saved only the OD pairs
# that we actually needed for trips in the survey. This shrunk the file
# to 560kb.
skim <- read_csv(
  "data/input/survey_processing/length_skim.csv", col_types = cols(
    .default = col_double()
  )
)

add_skim_info <- add_taz_id %>%
  left_join(
    skim, by = c("p_taz" = "Origin", "a_taz" = "Destination")
  ) %>%
  rename(skim_length = Length)
```

```{r}
se_2016 <- read_csv("data/output/se_data/se_2016.csv", col_types = cols(
  .default = col_double(),
  Type = col_character()  
))

to_join <- se_2016 %>%
  select(
    TAZ,
    ind = Industry,
    off = Office,
    svl = Service_RateLow,
    svh = Service_RateHigh,
    ret = Retail
  )

add_se_data <- add_skim_info %>%
  left_join(to_join, by = c("p_taz" = "TAZ")) %>%
  rename_with(~paste0("p_", .x), c(ind:ret)) %>%
  rowwise() %>%
  mutate(p_emp = sum(c_across(c(p_ind:p_ret)))) %>%
  left_join(to_join, by = c("a_taz" = "TAZ")) %>%
  rename_with(~paste0("a_", .x), c(ind:ret)) %>%
  mutate(a_emp = sum(c_across(c(a_ind:a_ret))))
```

## Exploratory Data Analysis

With the trip records fully processed, exploratory data analysis was used to
determine the trip types most appropriate for the Triangle region. Several
classification schemes were investigated, and each one classified trips by the
following categories:

- Tour type (work or non-work)
- Home-based (home-based or non-home-based)
- Purpose
- Destination activity duration (over or under 30 minutes)
  
Each classification was then summarized to produce 25 different metrics
including total trips, average trip length, mode and time of day shares, and
correlations to different variables. The table below provides a sample of these
metrics for one of the classification schemes tested.

Column definitions:

- **TourType**
  - `W`: Work
  - `N`: Non-work
- **Homebased**
  - `H`: Home-based (one trip end at home)
  - `N`: Non-home-based
- **Purpose**
  - Work tours:
    - `W`: Work
    - `WR`: Work related (e.g. a delivery)
    - `EK12`: Escort child to school
    - `O`: Other
  - Non-work tours:
    - `K12`: school (K-12)
    - `OME`: Maintenance, shopping, dining
    - `OMED`: Medical
- **Duration**
  - `Long`: Activity above 30 minutes
  - `Short`: Activity below 30 minutes
  - `All`: Long and short durations (meaning duration was not used to stratify)
- **Is Worker (r)**: Correlation between trip making and work status
- **Is Child (r)**: Correlation between trip making and age <18
- **Employment (r)**: Correlation between trips attracted to a zone and zonal
  employment
- **AM (%)**: Percentage of trips in the AM period (7:00 am - 9:00 am)
- **HOV (%)**: Percentage of trips using the high-occupancy vehicle mode
- **Trip Length**: Average trip length

```{r}
prep_for_eda <- add_se_data %>%
  mutate(
    homebased = ifelse(p_place == "H", "HB", "NH"),
    p_duration = ifelse(p_act_dur >= 30, "Long", "Short"),
    p_duration = ifelse(is.na(p_duration), "Long", p_duration),
    a_duration = ifelse(a_act_dur >= 30, "Long", "Short"),
    a_duration = ifelse(is.na(a_duration), "Long", a_duration),
    tod = case_when(
      departure_time < 7*60 ~ "NT",
      departure_time < 9*60 ~ "AM",
      departure_time < (3 + 12)*60 + 30 ~ "MD",
      departure_time < (6 + 12)*60 + 15 ~ "PM",
      TRUE ~ "NT"
    ),
    pk_op = ifelse(tod %in% c("AM", "PM"), "PK", "OP")
  )

# # Used in a manual exercise to convert TRMv6 OD matrices into G2 matrices.
# # This was part of the process to get initial congested skims.
# temp <- prep_for_eda %>%
#   mutate(old_tod = case_when(
#     departure_time < 6*60 ~ "NT",
#     departure_time < 10*60 ~ "AM",
#     departure_time < (3 + 12)*60 + 30 ~ "MD",
#     departure_time < (7 + 12)*60 + 30 ~ "PM",
#     TRUE ~ "NT"
#   )) %>%
#   group_by(old_tod, tod) %>%
#   summarize(trips = sum(trip_weight_combined, na.rm = TRUE)) %>%
#   mutate(pct = trips / sum(trips))
```

```{r eda_scheme1, eval=FALSE}
# This step adds the first purpose scheme defined by Vince
scheme1 <- prep_for_eda %>%
  mutate(
    purp_scheme = a_activity,
    dur_scheme = a_duration,
    # WT HB trips
    purp_scheme = case_when(
      tour_type != "W" ~ purp_scheme,
      homebased != "HB" ~ purp_scheme,
      purp_scheme %in% c("PUS", "DOS") ~ "EK12",
      purp_scheme %in% c("W", "EK12") ~ purp_scheme,
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "W" ~ dur_scheme,
      homebased != "HB" ~ dur_scheme,
      purp_scheme %in% c("W", "EK12") ~ "All",
      TRUE ~ dur_scheme
    ),
    # WT NHB trips
    purp_scheme = case_when(
      tour_type != "W" ~ purp_scheme,
      homebased != "NH" ~ purp_scheme,
      o_activity %in% c("PUS", "DOS") ~ "EK12",
      a_activity %in% c("PUS", "DOS") ~ "EK12",
      o_activity == "EK12" | a_activity == "EK12" ~ "EK12",
      o_activity == "EAT" | a_activity == "EAT" ~ "EAT",
      o_activity %in% c("W", "WR") | a_activity %in% c("W", "WR") ~ "WR",
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "W" ~ dur_scheme,
      homebased != "NH" ~ dur_scheme,
      purp_scheme %in% c("WR", "EK12", "EAT") ~ "All",
      TRUE ~ dur_scheme
    ),
    # NT HB trips
    purp_scheme = case_when(
      tour_type != "N" ~ purp_scheme,
      homebased != "HB" ~ purp_scheme,
      purp_scheme %in% c("PUS", "DOS") ~ "K12",
      purp_scheme %in% c("K12", "SHP", "EAT", "OM", "OMED") ~ purp_scheme,
      TRUE ~ "OD"
    ),
    dur_scheme = case_when(
      tour_type != "N" ~ dur_scheme,
      homebased != "HB" ~ dur_scheme,
      purp_scheme %in% c("K12", "EAT", "OM", "OMED") ~ "All",
      TRUE ~ dur_scheme
    ),
    # NT NHB trips
    purp_scheme = case_when(
      tour_type != "N" ~ purp_scheme,
      homebased != "NH" ~ purp_scheme,
      o_activity == "EAT" & a_activity == "SHP" ~ "EAT-SHP",
      o_activity == "SHP" & a_activity == "EAT" ~ "EAT-SHP",
      o_activity == "EAT" | a_activity == "EAT" ~ "EAT-O",
      o_activity == "SHP" | a_activity == "SHP" ~ "SHP",
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "N" ~ dur_scheme,
      homebased != "NH" ~ dur_scheme,
      purp_scheme %in% c("EAT-SHP", "EAT-O") ~ "All",
      TRUE ~ dur_scheme
    ),
  ) %>%
  relocate(c(tour_type, homebased), .before = purp_scheme)

eda_scheme1 <- person_eda(scheme1)
```

```{r eda_scheme2, eval=FALSE}
scheme2 <- prep_for_eda %>%
  mutate(
    purp_scheme = a_activity,
    dur_scheme = a_duration,
    # WT HB trips
    purp_scheme = case_when(
      tour_type != "W" ~ purp_scheme,
      homebased != "HB" ~ purp_scheme,
      purp_scheme %in% c("PUS", "DOS") ~ "EK12",
      purp_scheme %in% c("W", "EK12") ~ purp_scheme,
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "W" ~ dur_scheme,
      homebased != "HB" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # WT NHB trips
    purp_scheme = case_when(
      tour_type != "W" ~ purp_scheme,
      homebased != "NH" ~ purp_scheme,
      TRUE ~ "All"
    ),
    dur_scheme = case_when(
      tour_type != "W" ~ dur_scheme,
      homebased != "NH" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # NT HB trips
    purp_scheme = case_when(
      tour_type != "N" ~ purp_scheme,
      homebased != "HB" ~ purp_scheme,
      purp_scheme == "K12" ~ purp_scheme,
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "N" ~ dur_scheme,
      homebased != "HB" ~ dur_scheme,
      purp_scheme == "K12" ~ "All",
      TRUE ~ dur_scheme
    ),
    # NT NHB trips
    purp_scheme = case_when(
      tour_type != "N" ~ purp_scheme,
      homebased != "NH" ~ purp_scheme,
      TRUE ~ "All"
    ),
    dur_scheme = case_when(
      tour_type != "N" ~ dur_scheme,
      homebased != "NH" ~ dur_scheme,
      TRUE ~ "All"
    ),
  )

eda_scheme2 <- person_eda(scheme2)

eda_scheme2 %>%
  select(
    `Tour Type` = tour_type,
    Homebased = homebased,
    Purpose = purpose,
    `Dest Duration` = duration,
    `Trips (weighted)` = wTrips,
    `Is Worker (r)` = r_is_worker,
    `Is Child (r)` = r_is_kid,
    `Zonal Employment (r)` = r_emp,
    `AM (%)` = pct_AM,
    `HOV2 (%)` = pct_hov2,
    `Trip Length` = wAvgTrpLen
  ) %>%
  kable() %>%
  kable_styling()
```

```{r eda_scheme3, eval=FALSE}
scheme3 <- prep_for_eda %>%
  mutate(
    purp_scheme = a_activity,
    dur_scheme = a_duration,
    # WT HB trips
    purp_scheme = case_when(
      tour_type != "W" ~ purp_scheme,
      homebased != "HB" ~ purp_scheme,
      purp_scheme %in% c("PUS", "DOS") ~ "EK12",
      purp_scheme %in% c("W", "EK12") ~ purp_scheme,
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "W" ~ dur_scheme,
      homebased != "HB" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # WT NHB trips
    purp_scheme = case_when(
      tour_type != "W" ~ purp_scheme,
      homebased != "NH" ~ purp_scheme,
      tod %in% c("AM", "PM") ~ "PK",
      TRUE ~ "OP"
    ),
    dur_scheme = case_when(
      tour_type != "W" ~ dur_scheme,
      homebased != "NH" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # NT HB trips
    purp_scheme = case_when(
      tour_type != "N" ~ purp_scheme,
      homebased != "HB" ~ purp_scheme,
      purp_scheme == "K12" ~ purp_scheme,
      purp_scheme == "SHP" ~ purp_scheme,
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "N" ~ dur_scheme,
      homebased != "HB" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # NT NHB trips
    purp_scheme = case_when(
      tour_type != "N" ~ purp_scheme,
      homebased != "NH" ~ purp_scheme,
      TRUE ~ "All"
    ),
    dur_scheme = case_when(
      tour_type != "N" ~ dur_scheme,
      homebased != "NH" ~ dur_scheme,
      TRUE ~ "All"
    ),
  )

eda_scheme3 <- person_eda(scheme3)
```

```{r eda_scheme4, eval=FALSE}
scheme4 <- prep_for_eda %>%
  mutate(
    purp_scheme = a_activity,
    dur_scheme = a_duration,
    # WT HB trips
    purp_scheme = case_when(
      tour_type != "W" ~ purp_scheme,
      homebased != "HB" ~ purp_scheme,
      purp_scheme %in% c("PUS", "DOS") ~ "EK12",
      purp_scheme %in% c("W", "EK12") ~ purp_scheme,
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "W" ~ dur_scheme,
      homebased != "HB" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # WT NHB trips
    purp_scheme = case_when(
      tour_type != "W" ~ purp_scheme,
      homebased != "NH" ~ purp_scheme,
      TRUE ~ "All"
    ),
    dur_scheme = case_when(
      tour_type != "W" ~ dur_scheme,
      homebased != "NH" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # NT HB trips
    purp_scheme = case_when(
      tour_type != "N" ~ purp_scheme,
      homebased != "HB" ~ purp_scheme,
      purp_scheme == "K12" ~ purp_scheme,
      purp_scheme == "SHP" ~ purp_scheme,
      purp_scheme == "EAT" ~ purp_scheme,
      purp_scheme == "OMED" ~ "OM/MED",
      purp_scheme == "OM" ~ "OM/MED",
      TRUE ~ "OD"
    ),
    dur_scheme = case_when(
      tour_type != "N" ~ dur_scheme,
      homebased != "HB" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # NT NHB trips
    purp_scheme = case_when(
      tour_type != "N" ~ purp_scheme,
      homebased != "NH" ~ purp_scheme,
      o_activity %in% c("SHP", "EAT") & 
        a_activity %in% c("SHP", "EAT") ~ "SHP/EAT",
      o_activity %in% c("SHP", "EAT") | 
        a_activity %in% c("SHP", "EAT") ~ "SHP/EAT-O",
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "N" ~ dur_scheme,
      homebased != "NH" ~ dur_scheme,
      TRUE ~ "All"
    ),
  )

eda_scheme4 <- person_eda(scheme4)
```

```{r eda_scheme5, eval=FALSE}
scheme5 <- prep_for_eda %>%
  mutate(
    purp_scheme = a_activity,
    dur_scheme = a_duration,
    # WT HB trips
    purp_scheme = case_when(
      tour_type != "W" ~ purp_scheme,
      homebased != "HB" ~ purp_scheme,
      purp_scheme %in% c("PUS", "DOS") ~ "EK12",
      purp_scheme %in% c("W", "EK12") ~ purp_scheme,
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "W" ~ dur_scheme,
      homebased != "HB" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # WT NHB trips
    purp_scheme = case_when(
      tour_type != "W" ~ purp_scheme,
      homebased != "NH" ~ purp_scheme,
      tod %in% c("AM", "PM") ~ "PK",
      TRUE ~ "OP"
    ),
    dur_scheme = case_when(
      tour_type != "W" ~ dur_scheme,
      homebased != "NH" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # NT HB trips
    purp_scheme = case_when(
      tour_type != "N" ~ purp_scheme,
      homebased != "HB" ~ purp_scheme,
      purp_scheme == "K12" ~ purp_scheme,
      o_activity %in% c("SHP", "EAT") & 
        a_duration %in% c("SHP", "EAT") ~ "SHP/EAT",
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "N" ~ dur_scheme,
      homebased != "HB" ~ dur_scheme,
      purp_scheme == "K12" ~ "All",
      TRUE ~ dur_scheme
    ),
    # NT NHB trips
    purp_scheme = case_when(
      tour_type != "N" ~ purp_scheme,
      homebased != "NH" ~ purp_scheme,
      TRUE ~ "All"
    ),
    dur_scheme = case_when(
      tour_type != "N" ~ dur_scheme,
      homebased != "NH" ~ dur_scheme,
      p_duration == "Long" & a_duration == "Long" ~ "LL",
      p_duration == "Long" | a_duration == "Long" ~ "LS",
      TRUE ~ "SS"
    ),
  )

eda_scheme5 <- person_eda(scheme5)
```

```{r eda_scheme6}
# Scheme 6 was created largely by collapsing scheme1 after reviewing
# the results. It collapses the WT and NT-HB and then takes a different
# approach for NT-NHB.

scheme6 <- prep_for_eda %>%
  mutate(
    purp_scheme = a_activity,
    dur_scheme = a_duration,
    # WT HB trips
    purp_scheme = case_when(
      tour_type != "W" ~ purp_scheme,
      homebased != "HB" ~ purp_scheme,
      purp_scheme %in% c("PUS", "DOS") ~ "EK12",
      purp_scheme %in% c("W", "EK12") ~ purp_scheme,
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "W" ~ dur_scheme,
      homebased != "HB" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # WT NHB trips
    purp_scheme = case_when(
      tour_type != "W" ~ purp_scheme,
      homebased != "NH" ~ purp_scheme,
      o_activity %in% c("PUS", "DOS") ~ "EK12",
      a_activity %in% c("PUS", "DOS") ~ "EK12",
      o_activity == "EK12" | a_activity == "EK12" ~ "EK12",
      o_activity %in% c("W", "WR") | a_activity %in% c("W", "WR") ~ "WR",
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "W" ~ dur_scheme,
      homebased != "NH" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # NT HB trips
    purp_scheme = case_when(
      tour_type != "N" ~ purp_scheme,
      homebased != "HB" ~ purp_scheme,
      purp_scheme %in% c("PUS", "DOS") ~ "K12",
      purp_scheme == "K12" ~ "K12",
      purp_scheme == "OMED" ~ "OMED",
      purp_scheme %in% c("SHP", "EAT", "OM") ~ "OME",
      TRUE ~ "OD"
    ),
    dur_scheme = case_when(
      tour_type != "N" ~ dur_scheme,
      homebased != "HB" ~ dur_scheme,
      purp_scheme == "OD" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # NT NHB trips
    purp_scheme = case_when(
      tour_type != "N" ~ purp_scheme,
      homebased != "NH" ~ purp_scheme,
      a_activity %in% c("OM", "EAT", "SHP") | 
        p_activity %in% c("OM", "EAT", "SHP") ~ "OME",
      a_activity == "K12" | p_activity == "K12" ~ "K12",
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "N" ~ dur_scheme,
      homebased != "NH" ~ dur_scheme,
      purp_scheme %in% c("EAT-SHP", "EAT-O") ~ "All",
      TRUE ~ "All"
    )
  ) %>%
  relocate(c(tour_type, homebased), .before = purp_scheme)

eda_scheme6 <- person_eda(scheme6)

eda_scheme6 %>%
  select(
    `Tour Type` = tour_type,
    Homebased = homebased,
    Purpose = purpose,
    `Dest Duration` = duration,
    `Trips (weighted)` = wTrips,
    `Is Worker (r)` = r_is_worker,
    `Is Child (r)` = r_is_kid,
    `Zonal Employment (r)` = r_emp,
    `AM (%)` = pct_AM,
    `HOV2 (%)` = pct_hov2,
    `Trip Length` = wAvgTrpLen
  ) %>%
  kable() %>%
  kable_styling() %>%
  row_spec(which(eda_scheme6$homebased == "NH"), background = "lightgray")
```

```{r}
add_obs_trip_type <- scheme6 %>%
  unite(
    c(tour_type, homebased, purp_scheme, dur_scheme),
    col = "trip_type",
    remove = FALSE
  ) %>%
  mutate(obs_purpose = case_when(
    homebased == "NH" ~ "NHB",
    purp_scheme == "W" ~ "HBW",
    purp_scheme == "OME" ~ "HBShop",
    TRUE ~ "HBO"
  ))

add_hh_data <- add_obs_trip_type %>%
  left_join(
    hh_update_taz %>% select(
      hhid, hhsize, num_workers, num_vehicles, hh_inc_final, hh_inc_final_lab, choice_segment),
    by = "hhid"
  )
```


For example, the table above shows that if a person is a workers, they are more
likely to take trips on work tours and less likely to take trips on non-work
tours. Escort K12 trips are almost 100% HOV as expected (some parents walk their
kids to school). Medical trips (OMED) have a much longer trip length than other
non-home-based trips.

```{r eda_scheme7, eval=FALSE}
# Scheme 7 is a collapse of scheme6

scheme7 <- prep_for_eda %>%
  mutate(
    purp_scheme = a_activity,
    dur_scheme = a_duration,
    # WT HB trips
    purp_scheme = case_when(
      tour_type != "W" ~ purp_scheme,
      homebased != "HB" ~ purp_scheme,
      purp_scheme == "W" ~ "W",
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "W" ~ dur_scheme,
      homebased != "HB" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # WT NHB trips
    purp_scheme = case_when(
      tour_type != "W" ~ purp_scheme,
      homebased != "NH" ~ purp_scheme,
      o_activity %in% c("W", "WR") | a_activity %in% c("W", "WR") ~ "WR",
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "W" ~ dur_scheme,
      homebased != "NH" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # NT HB trips
    purp_scheme = case_when(
      tour_type != "N" ~ purp_scheme,
      homebased != "HB" ~ purp_scheme,
      purp_scheme %in% c("PUS", "DOS") ~ "K12",
      purp_scheme == "K12" ~ "K12",
      purp_scheme %in% c("SHP", "EAT", "OM", "OMED") ~ "OME",
      TRUE ~ "OD"
    ),
    dur_scheme = case_when(
      tour_type != "N" ~ dur_scheme,
      homebased != "HB" ~ dur_scheme,
      purp_scheme == "OD" ~ dur_scheme,
      TRUE ~ "All"
    ),
    # NT NHB trips
    purp_scheme = case_when(
      tour_type != "N" ~ purp_scheme,
      homebased != "NH" ~ purp_scheme,
      a_activity %in% c("OM", "EAT", "SHP") | 
        p_activity %in% c("OM", "EAT", "SHP") ~ "OME",
      TRUE ~ "O"
    ),
    dur_scheme = case_when(
      tour_type != "N" ~ dur_scheme,
      homebased != "NH" ~ dur_scheme,
      TRUE ~ "All"
    )
  ) %>%
  relocate(c(tour_type, homebased), .before = purp_scheme)

eda_scheme7 <- person_eda(scheme7)
```

## Summary

*TODO: add summary*

```{r write tables, eval=FALSE}
# These files will not be written during knitting, but must be done
# manually (consciously).

write_csv(
  hh_update_taz,
  "data/output/_PRIVATE/survey_processing/hh_processed.csv",
  na = ""
)
write_csv(
  per_add_flags,
  "data/output/_PRIVATE/survey_processing/per_processed.csv",
  na = ""
)
write_csv(
  add_hh_data,
  "data/output/_PRIVATE/survey_processing/trips_processed.csv",
  na = ""
)

# EDA tables
write_csv(
  eda_scheme1,
  "data/output/survey_processing/eda_scheme1.csv",
  na = ""
)
write_csv(
  eda_scheme2,
  "data/output/survey_processing/eda_scheme2.csv",
  na = ""
)
write_csv(
  eda_scheme3,
  "data/output/survey_processing/eda_scheme3.csv",
  na = ""
)
write_csv(
  eda_scheme4,
  "data/output/survey_processing/eda_scheme4.csv",
  na = ""
)
write_csv(
  eda_scheme5,
  "data/output/survey_processing/eda_scheme5.csv",
  na = ""
)
write_csv(
  eda_scheme6,
  "data/output/survey_processing/eda_scheme6.csv",
  na = ""
)
write_csv(
  eda_scheme7,
  "data/output/survey_processing/eda_scheme7.csv",
  na = ""
)
```

